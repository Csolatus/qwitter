{% extends 'base.html.twig' %}

{% block title %}Accueil / Qwitter{% endblock %}

{% block body %}
<div class="flex min-h-screen bg-white justify-center"> <!-- Centrage global -->
    
    <div class="flex w-full max-w-[1300px]"> <!-- Largeur max standard Twitter -->




        <!-- COLONNE 2 : FIL D'ACTUALITÃ‰ -->
        <main class="flex-1 max-w-[600px] w-full border-r border-gray-100 min-h-screen">
            
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="px-4 py-3 {{ label == 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' }} border-b border-white">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endfor %}

            <!-- Header Sticky -->
            <div class="sticky top-0 z-20 bg-white backdrop-blur-md border-b border-gray-100 flex">
                <a href="{{ path('app_accueil', {'feed': 'foryou'}) }}" class="flex-1 flex justify-center items-center hover:bg-gray-100 transition py-4">
                    <div class="relative">
                        <span class="{{ (current_feed is not defined or current_feed == 'foryou') ? 'font-bold text-slate-900' : 'font-medium text-gray-500' }}">Pour vous</span>
                        {% if current_feed is not defined or current_feed == 'foryou' %}
                            <div class="absolute -bottom-4 left-0 right-0 h-1 bg-slate-800 rounded-full"></div>
                        {% endif %}
                    </div>
                </a>
                <a href="{{ path('app_accueil', {'feed': 'following'}) }}" class="flex-1 flex justify-center items-center hover:bg-gray-100 transition py-4">
                    <div class="relative">
                        <span class="{{ (current_feed is defined and current_feed == 'following') ? 'font-bold text-slate-900' : 'font-medium text-gray-500' }}">Abonnements</span>
                        {% if current_feed is defined and current_feed == 'following' %}
                            <div class="absolute -bottom-4 left-0 right-0 h-1 bg-slate-800 rounded-full"></div>
                        {% endif %}
                    </div>
                </a>
            </div>

            <!-- CrÃ©ation de Post -->
            <div class="p-4 border-b border-gray-100 pb-2">
                {{ form_start(form, {'action': path('app_accueil'), 'attr': {'class': 'flex gap-4'}}) }}
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 overflow-hidden">
                        <!-- Avatar Utilisateur ConnectÃ© -->
                        {% if app.user and app.user.avatar %}
                            <img src="{{ asset('uploads/avatars/' ~ app.user.avatar) }}" class="w-full h-full object-cover">
                        {% elseif app.user %}
                             <img src="https://ui-avatars.com/api/?name={{ app.user.pseudo }}&background=0f172a&color=fff" class="w-full h-full object-cover">
                        {% else %}
                             <div class="w-full h-full bg-slate-800"></div>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        {{ form_widget(form.content) }}
                        <div class="text-red-500 text-sm py-1">{{ form_errors(form.content) }}</div>
                        
                                <!-- Image Preview Container -->
                        <div id="image-preview-container" class="hidden mt-2 relative inline-block">
                            <img id="image-preview" src="" alt="AperÃ§u" class="w-full h-auto max-h-80 rounded-xl object-contain bg-black/5 border border-gray-200">
                            <button type="button" id="remove-image-btn" class="absolute top-2 right-2 bg-gray-900/50 hover:bg-gray-900/70 text-white rounded-full p-1 transition backdrop-blur-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <!-- Poll Form Container -->
                        <div id="poll-form-container" class="hidden mt-3 border border-gray-200 rounded-xl p-4 bg-gray-50/50">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-sm font-bold text-gray-700">CrÃ©er un sondage</h3>
                                <button type="button" id="remove-poll-btn" class="text-gray-400 hover:text-red-500 transition">âœ•</button>
                            </div>
                            
                            {{ form_widget(form.pollQuestion) }}
                            
                            <div class="space-y-2 mt-2">
                                {{ form_widget(form.pollOption1) }}
                                {{ form_widget(form.pollOption2) }}
                                <div class="relative">
                                     {{ form_widget(form.pollOption3) }}
                                </div>
                                <div class="relative">
                                     {{ form_widget(form.pollOption4) }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-2 border-t border-gray-50 pt-2">
                            <div class="flex gap-1 text-slate-400 items-center">
                                <label id="image-upload-btn" for="{{ form.image.vars.id }}" class="hover:bg-blue-50 hover:text-blue-500 p-2 rounded-full transition cursor-pointer text-blue-400" title="Image">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a2.25 2.25 0 0 0 2.25-2.25V6.75a2.25 2.25 0 0 0-2.25-2.25H3.75a2.25 2.25 0 0 0-2.25 2.25v10.5a2.25 2.25 0 0 0 2.25 2.25Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                                    </svg>
                                </label>
                                {{ form_widget(form.image) }}
                                <div class="text-red-500 text-sm">{{ form_errors(form.image) }}</div>

                                <button type="button" id="gif-upload-btn" class="hover:bg-blue-50 hover:text-blue-500 p-2 rounded-full transition text-blue-400" title="GIF">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 8.25v7.5m6-7.5h-3V12m0 0v3.75m0-3.75H18M9.75 9.348c-1.03-1.464-2.698-1.464-3.728 0-1.03 1.465-1.03 4.84 0 6.304 1.03 1.464 2.699 1.464 3.728 0V12h-1.5M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" />
                                    </svg>
                                </button>
                                <button type="button" id="poll-toggle-btn" class="hover:bg-blue-50 hover:text-blue-500 p-2 rounded-full transition text-blue-400" title="Sondage">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0-3.75-3.75M17.25 21 21 17.25" />
                                    </svg>
                                </button>
                            </div>
                            <button type="submit" class="bg-slate-800 text-white px-5 py-1.5 rounded-full font-bold text-sm hover:bg-slate-900 transition">Poster</button>
                        </div>
                    </div>
                {{ form_end(form) }}
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const gifBtn = document.getElementById('gif-upload-btn');
                    const imageLabel = document.getElementById('image-upload-btn');
                    const fileInput = document.getElementById('{{ form.image.vars.id }}');

                    gifBtn.addEventListener('click', function() {
                        fileInput.accept = 'image/gif';
                        fileInput.click();
                    });

                    imageLabel.addEventListener('click', function() {
                        fileInput.accept = 'image/jpeg,image/png,image/webp,image/gif';
                    });
                    
                    // Reset accept on reload or form reset if needed, mostly handled by browser
                });
            </script>


            <!-- Fil des Posts -->
            <div class="posts-feed">
                {% for post in posts %}
                    {% include 'partials/_post.html.twig' with {'post': post} %}
                {% else %}
                    <!-- Ã‰tat vide -->
                    <div class="py-12 px-8 text-center">
                        <div class="text-4xl mb-4">ðŸ‘‹</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Bienvenue sur Qwitter !</h3>
                        <p class="text-gray-500 mb-6">Votre fil d'actualitÃ© est vide. Personne n'a encore postÃ© ?</p>
                        <button class="bg-slate-800 text-white px-6 py-2 rounded-full font-bold hover:bg-slate-900 transition">Poster le premier message</button>
                    </div>
                {% endfor %}
            </div>
        </main>


        <!-- COLONNE 3 : WIDGETS (Suggestions, Recherche) -->
        <aside class="hidden lg:block w-[350px] pl-8 py-4 h-screen sticky top-0 overflow-y-auto">
            


            <!-- Bloc Tendances -->
            <div class="bg-gray-50 rounded-2xl mb-4 overflow-hidden border border-gray-100">
                <h2 class="font-bold text-lg p-4 pb-2 text-slate-900">Tendances pour vous</h2>
                
                <div class="hover:bg-gray-100 px-4 py-3 cursor-pointer transition">
                    <div class="text-xs text-gray-500 flex justify-between">
                        <span>DÃ©veloppement Â· Tendance</span>
                        <button class="hover:bg-blue-50 rounded-full p-1">â€¢â€¢â€¢</button>
                    </div>
                    <div class="font-bold text-slate-800">#Symfony</div>
                    <div class="text-xs text-gray-500">2,458 posts</div>
                </div>

                <div class="hover:bg-gray-100 px-4 py-3 cursor-pointer transition">
                    <div class="text-xs text-gray-500 flex justify-between">
                        <span>Ã‰cole Â· Tendance</span>
                        <button class="hover:bg-blue-50 rounded-full p-1">â€¢â€¢â€¢</button>
                    </div>
                    <div class="font-bold text-slate-800">Projet Web</div>
                    <div class="text-xs text-gray-500">1,241 posts</div>
                </div>
                
                <a href="#" class="block p-4 text-blue-500 text-sm hover:bg-gray-100 transition rounded-b-2xl">Voir plus</a>
            </div>

            <!-- Bloc Suggestions (Dynamique) -->
            <div class="bg-gray-50 rounded-2xl overflow-hidden border border-gray-100">
                <h2 class="font-bold text-lg p-4 pb-2 text-slate-900">Suggestions</h2>
                
                {% for user in suggestions|default([]) %}
                    <div class="px-4 py-3 hover:bg-gray-100 flex items-center justify-between cursor-pointer transition">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden">
                                {% if user.avatar %}
                                    <img src="{{ asset('uploads/avatars/' ~ user.avatar) }}" class="w-full h-full object-cover">
                                {% else %}
                                    <img src="https://ui-avatars.com/api/?name={{ user.pseudo }}&background=random" class="w-full h-full object-cover">
                                {% endif %}
                            </div>
                            <div class="leading-tight">
                                <div class="font-bold text-slate-900 text-sm hover:underline">{{ user.fullName }}</div>
                                <div class="text-gray-500 text-xs">@{{ user.pseudo }}</div>
                            </div>
                        </div>
                        <form action="{{ path('app_follow', {'id': user.id}) }}" method="post" class="flex-shrink-0">
                            <input type="hidden" name="_token" value="{{ csrf_token('follow' ~ user.id) }}">
                            <button type="submit" class="bg-slate-900 text-white text-xs font-bold px-4 py-1.5 rounded-full hover:bg-slate-700 transition">Suivre</button>
                        </form>
                    </div>
                {% else %}
                    <div class="px-4 py-3 text-sm text-gray-500">Pas encore de suggestions.</div>
                {% endfor %}

                <a href="#" class="block p-4 text-blue-500 text-sm hover:bg-gray-100 transition rounded-b-2xl">Voir plus</a>
            </div>

            <nav class="flex flex-wrap gap-x-3 gap-y-1 mt-4 px-2 text-xs text-gray-400">
                <a href="#" class="hover:underline">Conditions</a>
                <a href="#" class="hover:underline">ConfidentialitÃ©</a>
                <a href="#" class="hover:underline">Cookies</a>
                <span>Â© 2026 Qwitter</span>
            </nav>

        </aside>

    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    function toggleCommentForm(postId) {
        const form = document.getElementById('comment-form-' + postId);
        form.classList.toggle('hidden');
    }

    // Image Preview Logic
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('post_image'); // ID gÃ©nÃ©rÃ© par Symfony, Ã  vÃ©rifier
        const previewContainer = document.getElementById('image-preview-container');
        const previewImage = document.getElementById('image-preview');
        const removeButton = document.getElementById('remove-image-btn');

        if (fileInput) {
            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        if (removeButton) {
            removeButton.addEventListener('click', function() {
                fileInput.value = ''; // Clear input
                previewContainer.classList.add('hidden');
                previewImage.src = '';
            });
        }

        // Poll Toggle Logic
        const pollBtn = document.getElementById('poll-toggle-btn');
        const pollContainer = document.getElementById('poll-form-container');
        const removePollBtn = document.getElementById('remove-poll-btn');

        if (pollBtn && pollContainer) {
            pollBtn.addEventListener('click', function() {
                pollContainer.classList.remove('hidden');
            });
        }

        if (removePollBtn && pollContainer) {
            removePollBtn.addEventListener('click', function() {
                pollContainer.classList.add('hidden');
                // Optional: clear poll inputs
                const inputs = pollContainer.querySelectorAll('input');
                inputs.forEach(input => input.value = '');
            });
        }
    });
</script>
{% endblock %}
